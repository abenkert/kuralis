<%= turbo_stream_from "shop_#{current_shop.id}_analyses" %>

<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <h1 class="h3 mb-0 text-gray-800">Bulk AI Product Creation</h1>
      <p class="text-muted">Upload product images and let AI help you create products faster</p>
    </div>
    <div class="col-auto">
      <%= link_to "Back to Products", kuralis_products_path, class: "btn btn-outline-secondary" %>
    </div>
  </div>

  <!-- Real-time Status Banner -->
  <% if @pending_analyses.any? || @processing_analyses.any? %>
    <div class="alert alert-info mb-4" id="processing-banner">
      <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-sm text-primary me-3" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div>
          <strong>AI Analysis in Progress</strong><br>
          <small>
            <%= @processing_analyses.count %> images currently being analyzed, 
            <%= @pending_analyses.count %> in queue. 
            <span class="text-muted">This page updates automatically.</span>
          </small>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Upload Progress Banner (shown when uploading) -->
  <% if params[:uploading] == 'true' %>
    <div class="alert alert-primary mb-4" id="upload-progress-banner">
      <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-sm text-primary me-3" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div class="flex-grow-1">
          <strong>Upload Complete - Processing Images</strong><br>
          <small>Your images have been uploaded and AI analysis is starting. This page will update automatically as results come in.</small>
        </div>
        <button type="button" class="btn-close" onclick="this.parentElement.parentElement.style.display='none'"></button>
      </div>
    </div>
  <% end %>

  <div class="row">
    <!-- Upload Section -->
    <div class="col-md-5">
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">Upload Images</h6>
        </div>
        <div class="card-body">
          <!-- Upload Form with Stimulus Controller -->
          <div data-controller="ai-upload" 
               data-ai-upload-max-files-value="500" 
               data-ai-upload-max-size-value="10485760">
            
            <form id="ai-upload-form" 
                  action="<%= kuralis_ai_product_analyses_path %>" 
                  method="post" 
                  enctype="multipart/form-data"
                  data-ai-upload-target="form"
                  data-action="submit->ai-upload#handleSubmit">
              <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
              
              <!-- Hidden file input -->
              <input type="file" 
                     name="images[]" 
                     multiple 
                     accept="image/*" 
                     class="d-none"
                     data-ai-upload-target="input"
                     data-action="change->ai-upload#handleFileSelect"
                     data-direct-upload-url="<%= rails_direct_uploads_url %>"
                     data-direct-upload="true">
              
              <!-- Dropzone Area -->
              <div class="dropzone-area p-5 text-center border rounded bg-light mb-4"
                   data-ai-upload-target="dropzone"
                   data-action="click->ai-upload#browse dragenter->ai-upload#dragEnter dragover->ai-upload#dragOver dragleave->ai-upload#dragLeave drop->ai-upload#handleDrop">
                <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                <h5 class="mb-2">Drop images here or click to browse</h5>
                <p class="text-muted mb-3">Upload multiple product images for AI analysis</p>
                <button type="button" class="btn btn-outline-primary">
                  <i class="fas fa-folder-open me-2"></i>Choose Files
                </button>
                <p class="text-muted small mt-3">
                  <i class="fas fa-info-circle me-1"></i>
                  Supports JPG, PNG, WebP • Up to 500 images • Max 10MB each
                </p>
              </div>
              
              <!-- File Preview Area -->
              <div data-ai-upload-target="previewContainer" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0">
                    <i class="fas fa-images me-2"></i>
                    Selected Files: <span data-ai-upload-target="fileCount">0</span>
                  </h6>
                  <div>
                    <button type="button" 
                            class="btn btn-sm btn-outline-secondary me-2"
                            data-action="click->ai-upload#clearFiles">
                      <i class="fas fa-trash me-1"></i>Clear All
                    </button>
                  </div>
                </div>
                
                <!-- File List -->
                <div data-ai-upload-target="fileList" class="mb-3"></div>
                
                <!-- Upload Progress -->
                <div data-ai-upload-target="progressContainer" class="d-none">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small fw-bold">Upload Progress</span>
                    <span class="small">
                      <span data-ai-upload-target="progressCurrent">0</span> / 
                      <span data-ai-upload-target="progressTotal">0</span>
                    </span>
                  </div>
                  <div class="progress mb-2">
                    <div data-ai-upload-target="progressBar" 
                         class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: 0%"></div>
                  </div>
                  <div class="small text-muted">
                    <i class="fas fa-spinner fa-spin me-1"></i>
                    <span data-ai-upload-target="progressStatus">Preparing upload...</span>
                  </div>
                </div>
              </div>
              
              <!-- Submit Button -->
              <div class="d-grid">
                <button type="submit" 
                        class="btn btn-primary btn-lg"
                        data-ai-upload-target="submitButton">
                  <i class="fas fa-magic me-2"></i>Upload & Analyze Images
                </button>
              </div>
            </form>
          </div>
          
          <!-- Instructions -->
          <div class="mt-4">
            <h6 class="font-weight-bold">How it works:</h6>
            <ol class="small text-muted mb-3">
              <li>Upload one or more product images</li>
              <li>Our AI analyzes each image and extracts product details</li>
              <li>Draft products are automatically created from AI analysis</li>
              <li>Review and finalize draft products to list them</li>
            </ol>
            
            <div class="alert alert-info small">
              <h6 class="font-weight-bold text-primary mb-2">
                <i class="fas fa-lightbulb me-1"></i>Pro Tips for Best Results:
              </h6>
              <ul class="mb-0 small">
                <li><strong>File Names:</strong> Use descriptive names (e.g., "batman-1-cgc-9.8.jpg")</li>
                <li><strong>Image Quality:</strong> Clear, well-lit photos work best</li>
                <li><strong>One Product Per Image:</strong> Separate images for each item</li>
                <li><strong>Sequential Processing:</strong> Use bulk finalization for efficient workflow</li>
                <li><strong>Optimized Processing:</strong> Images are automatically compressed for faster AI analysis</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Analysis Results Section -->
    <div class="col-md-7">
      <div class="card shadow mb-4">
        <div class="card-header py-3" id="analysis_counters">
          <ul class="nav nav-tabs card-header-tabs" id="analysisTab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="analyses-tab" data-bs-toggle="tab" data-bs-target="#analyses" type="button" role="tab" aria-controls="analyses" aria-selected="true">
                <i class="fas fa-spinner me-1"></i> Processing
                <% if @pending_analyses.any? || @processing_analyses.any? %>
                  <span class="badge bg-primary ms-1"><%= @pending_analyses.count + @processing_analyses.count %></span>
                <% end %>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="drafts-tab" data-bs-toggle="tab" data-bs-target="#drafts" type="button" role="tab" aria-controls="drafts" aria-selected="false">
                <i class="fas fa-pencil-alt me-1"></i> Draft Products
                <% if @draft_products.any? %>
                  <span class="badge bg-warning ms-1"><%= @draft_products.count %></span>
                <% end %>
              </button>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content" id="analysisTabContent">
            <!-- Pending Analyses Tab -->
            <div class="tab-pane fade show active" id="analyses" role="tabpanel" aria-labelledby="analyses-tab">
              <% if @pending_analyses.any? || @processing_analyses.any? %>
                <div id="ai_analyses" class="row">
                  <% (@pending_analyses + @processing_analyses).each do |analysis| %>
                    <%= render partial: "kuralis/ai_product_analyses/ai_analysis_item", locals: { analysis: analysis } %>
                  <% end %>
                </div>
              <% else %>
                <div class="text-center py-5">
                  <i class="fas fa-images fa-3x text-muted mb-3"></i>
                  <p class="mb-0">No pending analyses at the moment.</p>
                  <p class="text-muted">Upload images to begin the AI analysis process. Draft products are created automatically when analysis completes.</p>
                </div>
              <% end %>
            </div>
            
            <!-- Draft Products Tab -->
            <div class="tab-pane fade" id="drafts" role="tabpanel" aria-labelledby="drafts-tab">
              <% if @draft_products.any? %>
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0">Draft Products Ready for Finalization</h6>
                  <%= form_with url: start_finalize_sequence_kuralis_draft_products_path, 
                                method: :post, 
                                local: true, 
                                class: "d-inline" do |form| %>
                    <%= form.submit "🔄 Finalize All Sequentially", 
                                    class: "btn btn-warning btn-sm" %>
                  <% end %>
                </div>
                <div class="row">
                  <% @draft_products.each do |product| %>
                    <div class="col-md-6 mb-4" id="draft_product_<%= product.id %>">
                      <div class="analysis-item position-relative">
                        <% if product.images.attached? %>
                          <% begin %>
                            <%= image_tag product.images.first.variant(resize_to_limit: [300, 200]), 
                                          class: "analysis-image",
                                          loading: "lazy",
                                          style: "object-fit: cover; width: 100%; height: 150px;" %>
                          <% rescue ActiveStorage::FileNotFoundError => e %>
                            <div class="analysis-image bg-light d-flex align-items-center justify-content-center">
                              <div class="text-center text-muted">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <small>Image not found</small>
                              </div>
                            </div>
                          <% end %>
                        <% else %>
                          <div class="analysis-image bg-light d-flex align-items-center justify-content-center">
                            <i class="fas fa-image fa-3x text-muted"></i>
                          </div>
                        <% end %>
                        <div class="analysis-status bg-warning text-dark">
                          Draft
                        </div>
                        <div class="p-3">
                          <h6 class="mb-2 font-weight-bold">
                            <%= product.title %>
                          </h6>
                          <p class="small text-muted mb-3">
                            <%= truncate(product.description.presence || "No description available", length: 100) %>
                          </p>
                          
                          <!-- AI Confidence Badges -->
                          <div class="mb-3">
                            <% if product.ai_product_analysis.present? %>
                              <% analysis = product.ai_product_analysis %>
                              <% if analysis.suggested_brand.present? %>
                                <span class="badge bg-info me-1"><%= analysis.suggested_brand %></span>
                              <% end %>
                              <span class="badge bg-secondary me-1">Price: TBD</span>
                              <% if analysis.suggested_category_confidence > 0 %>
                                <span class="badge bg-<%= analysis.category_confidence_level == 'high' ? 'success' : analysis.category_confidence_level == 'medium' ? 'warning' : 'danger' %> me-1">
                                  Category: <%= (analysis.suggested_category_confidence * 100).round %>%
                                </span>
                              <% end %>
                              <% if analysis.suggested_item_specifics_confidence > 0 %>
                                <span class="badge bg-<%= analysis.item_specifics_confidence_level == 'high' ? 'success' : analysis.item_specifics_confidence_level == 'medium' ? 'warning' : 'danger' %> me-1">
                                  Specifics: <%= (analysis.suggested_item_specifics_confidence * 100).round %>%
                                </span>
                              <% end %>
                              <% if analysis.requires_category_review? %>
                                <span class="badge bg-warning text-dark me-1">
                                  <i class="fas fa-exclamation-triangle me-1"></i>Category Review
                                </span>
                              <% end %>
                              <% if analysis.requires_specifics_review? %>
                                <span class="badge bg-warning text-dark me-1">
                                  <i class="fas fa-exclamation-triangle me-1"></i>Specifics Review
                                </span>
                              <% end %>
                              <% if analysis.missing_required_specifics.any? %>
                                <span class="badge bg-danger me-1" title="Missing: <%= analysis.missing_required_specifics.join(', ') %>">
                                  <i class="fas fa-exclamation-circle me-1"></i><%= analysis.missing_required_specifics.size %> Missing
                                </span>
                              <% end %>
                            <% else %>
                              <% if product.brand.present? %>
                                <span class="badge bg-info me-1"><%= product.brand %></span>
                              <% end %>
                              <% if product.base_price.present? %>
                                <span class="badge bg-success me-1"><%= number_to_currency(product.base_price) %></span>
                              <% else %>
                                <span class="badge bg-secondary me-1">Price: TBD</span>
                              <% end %>
                            <% end %>
                          </div>
                          
                          <div class="d-flex justify-content-end">
                            <%= link_to edit_kuralis_product_path(product, finalize: true), 
                                class: "btn btn-sm btn-warning" do %>
                              <i class="fas fa-edit me-1"></i> Edit & Finalize
                            <% end %>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <div class="text-center py-5">
                  <i class="fas fa-pencil-alt fa-3x text-muted mb-3"></i>
                  <p class="mb-0">No draft products available.</p>
                  <p class="text-muted">Upload images to create draft products automatically from AI analysis.</p>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .dropzone-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .dropzone-area:hover,
  .dropzone-area.dropzone-active {
    border-color: #4e73df;
    background-color: #f0f4ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(78, 115, 223, 0.15);
  }
  
  .analysis-item {
    border: 1px solid #e3e6f0;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .analysis-item:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }
  
  .analysis-image {
    height: 150px;
    width: 100%;
    object-fit: cover;
  }
  
  .analysis-status {
    position: absolute;
    top: 10px;
    right: 10px;
    border-radius: 50px;
    padding: 2px 10px;
    font-size: 0.7rem;
    font-weight: bold;
    text-transform: uppercase;
  }
  
  .status-pending {
    background-color: #f8f9fa;
    color: #5a5c69;
  }
  
  .status-processing {
    background-color: #36b9cc;
    color: white;
  }
  
  .status-completed {
    background-color: #1cc88a;
    color: white;
  }
  
  .status-failed {
    background-color: #e74a3b;
    color: white;
  }
  
  /* File preview styles */
  .file-item {
    background-color: #f8f9fa;
    transition: all 0.2s ease;
  }
  
  .file-item:hover {
    background-color: #e9ecef;
    transform: translateX(4px);
  }
  
  .file-group {
    background-color: #ffffff;
    transition: all 0.2s ease;
  }
  
  .file-group:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  .group-header {
    cursor: pointer;
  }
  
  .group-header:hover {
    background-color: #e9ecef !important;
  }
  
  /* Progress bar enhancements */
  .progress {
    height: 8px;
    border-radius: 4px;
    background-color: #e9ecef;
  }
  
  .progress-bar {
    border-radius: 4px;
    background: linear-gradient(45deg, #4e73df, #36b9cc);
  }
  
  /* Button enhancements */
  .btn-primary.btn-lg {
    padding: 12px 24px;
    font-weight: 600;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(78, 115, 223, 0.3);
    transition: all 0.3s ease;
  }
  
  .btn-primary.btn-lg:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(78, 115, 223, 0.4);
  }
  
  .btn-primary.btn-lg:disabled {
    transform: none;
    box-shadow: none;
  }
</style>

<script>
  // Initialize tabs on page load
  document.addEventListener('DOMContentLoaded', function() {
    // Check if there's a tab parameter in the URL
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab');
    
    if (tab === 'drafts') {
      // Find and click the drafts tab button
      const draftsTab = document.getElementById('drafts-tab');
      if (draftsTab) draftsTab.click();
    } else if (tab === 'processing') {
      // Find and click the processing tab button
      const processingTab = document.getElementById('analyses-tab');
      if (processingTab) processingTab.click();
    } else {
      // If no processing analyses, default to drafts tab
      const processingCount = <%= (@pending_analyses.count + @processing_analyses.count) %>;
      const draftsCount = <%= @draft_products.count %>;
      
      if (processingCount === 0 && draftsCount > 0) {
        const draftsTab = document.getElementById('drafts-tab');
        if (draftsTab) draftsTab.click();
      }
    }
  });

  document.addEventListener('turbo:load', function() {
    // Check if there's a tab parameter in the URL
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab');
    
    if (tab === 'drafts') {
      // Find and click the drafts tab button
      const draftsTab = document.getElementById('drafts-tab');
      if (draftsTab) draftsTab.click();
    } else if (tab === 'processing') {
      // Find and click the processing tab button
      const processingTab = document.getElementById('analyses-tab');
      if (processingTab) processingTab.click();
    } else {
      // If no processing analyses, default to drafts tab
      const processingCount = <%= (@pending_analyses.count + @processing_analyses.count) %>;
      const draftsCount = <%= @draft_products.count %>;
      
      if (processingCount === 0 && draftsCount > 0) {
        const draftsTab = document.getElementById('drafts-tab');
        if (draftsTab) draftsTab.click();
      }
    }
  });
</script>