<% content_for :title, "Sequential Product Finalization" %>

<div class="container-fluid">
  <!-- Header with Progress -->
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <!-- Progress Section -->
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h1 class="h3 mb-0 text-gray-800">Sequential Product Finalization</h1>
          <div class="text-muted small">
            Product <%= @progress[:current] %> of <%= @progress[:total] %>
            (<%= @progress[:completed] %> completed)
          </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress mb-2" style="height: 12px;">
          <div class="progress-bar bg-primary" 
               role="progressbar" 
               style="width: <%= @progress[:percentage] %>%"
               aria-valuenow="<%= @progress[:percentage] %>" 
               aria-valuemin="0" 
               aria-valuemax="100"></div>
        </div>
        <div class="text-muted small">
          <%= @progress[:percentage] %>% complete
        </div>
      </div>

      <!-- Confidence Indicators -->
      <% if @analysis %>
        <div class="d-flex flex-wrap gap-2 mb-3">
          <span class="text-muted small me-2">AI Analysis Quality:</span>
          <% category_confidence = (@analysis.suggested_category_confidence * 100).round %>
          <span class="badge <%= case category_confidence
                                 when 80..100 then 'bg-success'
                                 when 60..79 then 'bg-warning'
                                 else 'bg-danger'
                                 end %>">
            Category: <%= category_confidence %>%
          </span>
          
          <% specifics_confidence = (@analysis.suggested_item_specifics_confidence * 100).round %>
          <span class="badge <%= case specifics_confidence
                                when 80..100 then 'bg-success'
                                when 60..79 then 'bg-warning'
                                else 'bg-danger'
                                end %>">
            Specifics: <%= specifics_confidence %>%
          </span>
          
          <% if @analysis.requires_category_review? || @analysis.requires_specifics_review? %>
            <span class="badge bg-warning text-dark">
              <i class="fas fa-exclamation-triangle me-1"></i>Review Recommended
            </span>
          <% end %>
        </div>
      <% end %>

      <!-- Navigation Controls -->
      <div class="d-flex justify-content-between">
        <div>
          <%= link_to "Exit Sequence", 
                      exit_sequence_kuralis_draft_products_path, 
                      method: :post,
                      class: "btn btn-outline-secondary",
                      data: { confirm: "Are you sure you want to exit? Your progress will be saved." } %>
        </div>
        
        <div class="d-flex gap-2">
          <%= link_to "Skip", 
                      sequential_skip_kuralis_draft_products_path, 
                      method: :post,
                      class: "btn btn-outline-secondary" %>
          
          <%= link_to "Delete", 
                      sequential_delete_kuralis_draft_products_path, 
                      method: :delete,
                      class: "btn btn-outline-danger",
                      data: { confirm: "Are you sure you want to delete this draft? This action cannot be undone." } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="row">
    <div class="col-12">
      <%= render 'kuralis/products/form',
                 product: @product,
                 form_url: sequential_update_kuralis_draft_products_path,
                 form_method: :patch,
                 submit_text: "Finalize & Next",
                 cancel_url: exit_sequence_kuralis_draft_products_path,
                 show_skip_button: true,
                 skip_url: sequential_skip_kuralis_draft_products_path %>
    </div>
  </div>
</div> 