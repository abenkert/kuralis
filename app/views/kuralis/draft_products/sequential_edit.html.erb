<% content_for :title, "Sequential Product Finalization" %>

<div class="container-fluid">
  <!-- Header with Progress -->
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <!-- Progress Section -->
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h1 class="h3 mb-0 text-gray-800">Sequential Product Finalization</h1>
          <div class="text-muted small">
            Product <%= @progress[:current] %> of <%= @progress[:total] %>
            (<%= @progress[:completed] %> completed)
          </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress mb-2" style="height: 12px;">
          <div class="progress-bar bg-primary" 
               role="progressbar" 
               style="width: <%= @progress[:percentage] %>%"
               aria-valuenow="<%= @progress[:percentage] %>" 
               aria-valuemin="0" 
               aria-valuemax="100"></div>
        </div>
        <div class="text-muted small">
          <%= @progress[:percentage] %>% complete
        </div>
      </div>

      <!-- Confidence Indicators -->
      <% if @analysis %>
        <div class="d-flex flex-wrap gap-2 mb-3">
          <span class="text-muted small me-2">AI Analysis Quality:</span>
          <% category_confidence = (@analysis.suggested_category_confidence * 100).round %>
          <span class="badge <%= case category_confidence
                                 when 80..100 then 'bg-success'
                                 when 60..79 then 'bg-warning'
                                 else 'bg-danger'
                                 end %>">
            Category: <%= category_confidence %>%
          </span>
          
          <% specifics_confidence = (@analysis.suggested_item_specifics_confidence * 100).round %>
          <span class="badge <%= case specifics_confidence
                                when 80..100 then 'bg-success'
                                when 60..79 then 'bg-warning'
                                else 'bg-danger'
                                end %>">
            Specifics: <%= specifics_confidence %>%
          </span>
          
          <% if @analysis.requires_category_review? || @analysis.requires_specifics_review? %>
            <span class="badge bg-warning text-dark">
              <i class="fas fa-exclamation-triangle me-1"></i>Review Recommended
            </span>
          <% end %>
        </div>
      <% end %>

      <!-- Navigation Controls -->
      <div class="d-flex justify-content-between">
        <div>
          <%= link_to "Exit Sequence", 
                      exit_sequence_kuralis_draft_products_path, 
                      method: :post,
                      class: "btn btn-outline-secondary",
                      data: { confirm: "Are you sure you want to exit? Your progress will be saved." } %>
        </div>
        
        <div class="d-flex gap-2">
          <%= link_to "Skip", 
                      sequential_skip_kuralis_draft_products_path, 
                      method: :post,
                      class: "btn btn-outline-secondary" %>
          
          <%= link_to "Delete", 
                      sequential_delete_kuralis_draft_products_path, 
                      method: :delete,
                      class: "btn btn-outline-danger",
                      data: { confirm: "Are you sure you want to delete this draft? This action cannot be undone." } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="row">
    <div class="col-12">
      <%= form_with model: [@product], 
                    url: sequential_update_kuralis_draft_products_path, 
                    method: :patch, 
                    local: true do |form| %>
        
        <!-- Product Information Section -->
        <div class="card shadow mb-4">
          <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Product Information</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <!-- Title -->
              <div class="col-12 mb-3">
                <%= form.label :title, class: "form-label" %>
                <%= form.text_field :title, 
                                    class: "form-control #{'is-invalid' if @product.errors[:title].any?}",
                                    required: true %>
                <% if @product.errors[:title].any? %>
                  <div class="invalid-feedback"><%= @product.errors[:title].first %></div>
                <% end %>
              </div>

              <!-- Description -->
              <div class="col-12 mb-3">
                <%= form.label :description, class: "form-label" %>
                <%= form.text_area :description, 
                                   rows: 6,
                                   class: "form-control #{'is-invalid' if @product.errors[:description].any?}",
                                   required: true %>
                <% if @product.errors[:description].any? %>
                  <div class="invalid-feedback"><%= @product.errors[:description].first %></div>
                <% end %>
              </div>

              <!-- Price and Quantity Row -->
              <div class="col-md-6 mb-3">
                <%= form.label :base_price, "Price ($)", class: "form-label" %>
                <%= form.number_field :base_price, 
                                      step: 0.01, 
                                      min: 0,
                                      class: "form-control #{'is-invalid' if @product.errors[:base_price].any?}",
                                      required: true %>
                <% if @product.errors[:base_price].any? %>
                  <div class="invalid-feedback"><%= @product.errors[:base_price].first %></div>
                <% end %>
              </div>

              <div class="col-md-6 mb-3">
                <%= form.label :base_quantity, "Quantity", class: "form-label" %>
                <%= form.number_field :base_quantity, 
                                      min: 1,
                                      class: "form-control #{'is-invalid' if @product.errors[:base_quantity].any?}",
                                      required: true %>
                <% if @product.errors[:base_quantity].any? %>
                  <div class="invalid-feedback"><%= @product.errors[:base_quantity].first %></div>
                <% end %>
              </div>

              <!-- Brand and Condition Row -->
              <div class="col-md-6 mb-3">
                <%= form.label :brand, class: "form-label" %>
                <%= form.text_field :brand, 
                                    class: "form-control #{'is-invalid' if @product.errors[:brand].any?}" %>
                <% if @product.errors[:brand].any? %>
                  <div class="invalid-feedback"><%= @product.errors[:brand].first %></div>
                <% end %>
              </div>

              <div class="col-md-6 mb-3">
                <%= form.label :condition, class: "form-label" %>
                <%= form.select :condition, 
                                options_for_select([
                                  ['New', 'new'],
                                  ['Like New', 'like_new'],
                                  ['Very Good', 'very_good'],
                                  ['Good', 'good'],
                                  ['Acceptable', 'acceptable'],
                                  ['For Parts or Not Working', 'for_parts']
                                ], @product.condition),
                                { prompt: 'Select condition' },
                                { class: "form-select #{'is-invalid' if @product.errors[:condition].any?}" } %>
                <% if @product.errors[:condition].any? %>
                  <div class="invalid-feedback"><%= @product.errors[:condition].first %></div>
                <% end %>
              </div>

              <!-- Weight -->
              <div class="col-md-6 mb-3">
                <%= form.label :weight_oz, "Weight (oz)", class: "form-label" %>
                <%= form.number_field :weight_oz, 
                                      step: 0.1, 
                                      min: 0,
                                      class: "form-control #{'is-invalid' if @product.errors[:weight_oz].any?}" %>
                <% if @product.errors[:weight_oz].any? %>
                  <div class="invalid-feedback"><%= @product.errors[:weight_oz].first %></div>
                <% end %>
              </div>

              <!-- Tags -->
              <div class="col-12 mb-3">
                <%= form.label :tags, class: "form-label" %>
                <div class="mb-2">
                  <% if @product.tags.present? %>
                    <% @product.tags.each_with_index do |tag, index| %>
                      <input type="hidden" name="kuralis_product[tags][]" value="<%= tag %>">
                    <% end %>
                  <% end %>
                  <input type="text" 
                         id="tags-input" 
                         placeholder="Add tags (press Enter to add)"
                         class="form-control">
                </div>
                <div id="tags-container" class="d-flex flex-wrap gap-1">
                  <% if @product.tags.present? %>
                    <% @product.tags.each do |tag| %>
                      <span class="badge bg-primary d-flex align-items-center">
                        <%= tag %>
                        <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.6em;" onclick="removeTag(this, '<%= tag %>')"></button>
                        <input type="hidden" name="kuralis_product[tags][]" value="<%= tag %>">
                      </span>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- eBay Attributes Section -->
        <%= form.fields_for :ebay_product_attribute do |ebay_form| %>
          <div class="card shadow mb-4">
            <div class="card-header py-3">
              <h6 class="m-0 font-weight-bold text-primary">eBay Listing Details</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Category -->
                <div class="col-12 mb-3">
                  <%= ebay_form.label :category_id, "eBay Category", class: "form-label" %>
                  <%= ebay_form.text_field :category_id, 
                                           class: "form-control #{'is-invalid' if @product.ebay_product_attribute&.errors&.[](:category_id)&.any?}",
                                           placeholder: "Search for eBay category..." %>
                  <% if @product.ebay_product_attribute&.errors&.[](:category_id)&.any? %>
                    <div class="invalid-feedback"><%= @product.ebay_product_attribute.errors[:category_id].first %></div>
                  <% end %>
                </div>

                <!-- Item Specifics -->
                <% if @product.ebay_product_attribute&.item_specifics.present? %>
                  <div class="col-12 mb-3">
                    <label class="form-label">Item Specifics</label>
                    <div class="row">
                      <% @product.ebay_product_attribute.item_specifics.each do |key, value| %>
                        <div class="col-md-6 mb-2">
                          <label class="form-label small text-muted"><%= key.humanize %></label>
                          <input type="text" 
                                 name="kuralis_product[ebay_product_attribute_attributes][item_specifics][<%= key %>]" 
                                 value="<%= value %>"
                                 class="form-control">
                        </div>
                      <% end %>
                    </div>
                  </div>
                <% end %>

                <!-- Condition and Duration -->
                <div class="col-md-6 mb-3">
                  <%= ebay_form.label :condition_id, "eBay Condition", class: "form-label" %>
                  <%= ebay_form.select :condition_id, 
                                       options_for_select([
                                         ['New', 1000],
                                         ['New other (see details)', 1500],
                                         ['New with defects', 1750],
                                         ['Manufacturer refurbished', 2000],
                                         ['Seller refurbished', 2500],
                                         ['Used', 3000],
                                         ['Very Good', 4000],
                                         ['Good', 5000],
                                         ['Acceptable', 6000],
                                         ['For parts or not working', 7000]
                                       ], @product.ebay_product_attribute&.condition_id),
                                       { prompt: 'Select eBay condition' },
                                       { class: "form-select" } %>
                </div>

                <div class="col-md-6 mb-3">
                  <%= ebay_form.label :listing_duration, "Listing Duration", class: "form-label" %>
                  <%= ebay_form.select :listing_duration, 
                                       options_for_select([
                                         ['3 days', 'Days_3'],
                                         ['5 days', 'Days_5'],
                                         ['7 days', 'Days_7'],
                                         ['10 days', 'Days_10'],
                                         ['30 days', 'Days_30'],
                                         ['Good Till Cancelled', 'GTC']
                                       ], @product.ebay_product_attribute&.listing_duration || 'GTC'),
                                       {},
                                       { class: "form-select" } %>
                </div>

                <!-- Best Offer -->
                <div class="col-12 mb-3">
                  <div class="form-check">
                    <%= ebay_form.check_box :best_offer_enabled, 
                                            class: "form-check-input" %>
                    <%= ebay_form.label :best_offer_enabled, "Enable Best Offer", class: "form-check-label" %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-end gap-2 mb-4">
          <%= link_to "Skip", 
                      sequential_skip_kuralis_draft_products_path, 
                      method: :post,
                      class: "btn btn-outline-secondary" %>
          
          <%= form.submit "Finalize & Next", 
                          class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Tags JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const tagsInput = document.getElementById('tags-input');
  const tagsContainer = document.getElementById('tags-container');
  
  if (tagsInput) {
    tagsInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const tag = this.value.trim();
        if (tag && !isTagExists(tag)) {
          addTag(tag);
          this.value = '';
        }
      }
    });
  }
  
  function addTag(tag) {
    const tagElement = document.createElement('span');
    tagElement.className = 'badge bg-primary d-flex align-items-center';
    tagElement.innerHTML = `
      ${tag}
      <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.6em;" onclick="removeTag(this, '${tag}')"></button>
      <input type="hidden" name="kuralis_product[tags][]" value="${tag}">
    `;
    tagsContainer.appendChild(tagElement);
  }
  
  function isTagExists(tag) {
    const existingTags = Array.from(document.querySelectorAll('input[name="kuralis_product[tags][]"]'));
    return existingTags.some(input => input.value === tag);
  }
});

function removeTag(button, tag) {
  const tagElement = button.closest('span');
  tagElement.remove();
}
</script> 