<div class="container" 
    data-controller="bulk-listing"
    data-bulk-listing-total-count-value="<%= @total_count %>">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center gap-3">
      <%= link_to kuralis_products_path, class: "btn btn-outline-secondary" do %>
        <i class="bi bi-arrow-left"></i> Back to Products
      <% end %>
      <h1>Bulk List to <%= @platform.titleize %></h1>
    </div>
    <div class="text-muted">
      <%= @products.total_count %> products available for listing
    </div>
  </div>

  <% if @active_job_run.present? %>
    <div class="alert alert-info mb-4">
      <h5><i class="bi bi-arrow-repeat me-2"></i> Bulk Listing in Progress</h5>
      <p>There's currently a bulk listing operation in progress (Job #<%= @active_job_run.job_id %>).</p>
      
      <% platforms = @active_job_run.arguments["platforms"] || [] %>
      <% batch_index = @active_job_run.arguments["batch_index"] || 0 %>
      <% total_batches = @active_job_run.arguments["total_batches"] || 1 %>
      <% percent_complete = ((batch_index.to_f / total_batches) * 100).round %>
      
      <div class="mb-2">
        <strong>Platforms:</strong> <%= platforms.map(&:titleize).join(", ") %>
        <div class="mb-2">
          <strong>Progress:</strong> 
          Processing batch <%= batch_index + 1 %> of <%= total_batches %>
          
          <div class="progress" style="height: 10px;">
            <div class="progress-bar" 
                 role="progressbar" 
                 style="width: <%= percent_complete %>%;" 
                 aria-valuenow="<%= batch_index %>" 
                 aria-valuemin="0" 
                 aria-valuemax="<%= total_batches %>">
            </div>
          </div>
        </div>
      </div>
      
      <p class="text-muted mb-0">Started <%= time_ago_in_words(@active_job_run.created_at) %> ago</p>
      
      <%= link_to "View Job Details", kuralis_jobs_path(id: @active_job_run.job_id), class: "btn btn-sm btn-outline-primary mt-2" %>
    </div>
  <% end %>

  <%= form_tag kuralis_bulk_listings_path, 
      method: :post, 
      class: 'bulk-listing-form',
      data: { action: "submit->bulk-listing#submitForm" } do %>
    <%= hidden_field_tag :platform, @platform %>
    <%= hidden_field_tag :select_all_records, '0', id: 'select-all-records-hidden',
        data: { bulk_listing_target: "selectAllRecords" } %>
    <%= hidden_field_tag :deselected_ids, '[]',
        data: { bulk_listing_target: "deselectedIds" } %>
    
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="form-check">
            <%= check_box_tag 'select_all', '1', true, class: 'form-check-input', id: 'select-all' %>
            <label class="form-check-label" for="select-all">Select All</label>
          </div>

          <div class="input-group w-25">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" 
                class="form-control" 
                placeholder="Search products..."
                data-bulk-listing-target="searchInput"
                data-action="input->bulk-listing#search">
          </div>

          <%= submit_tag "List Selected Products", 
              class: 'btn btn-primary',
              data: { 
                confirm: "Are you sure you want to list the selected products on #{@platform.titleize}?" 
              } %>
        </div>

        <div id="selected-count" class="alert alert-info mb-3"
            data-bulk-listing-target="selectedCount">
          <!-- Count will be populated by JavaScript -->
        </div>

        <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
          <table class="table table-hover">
            <thead class="sticky-top bg-white">
              <tr>
                <th></th>
                <th>Image</th>
                <th>Title</th>
                <th>SKU</th>
                <th>Base Price</th>
                <th>Location</th>
                <th>Source</th>
              </tr>
            </thead>
            <tbody>
              <% @products.each do |product| %>
                <tr class="product-row" data-bulk-listing-target="productRow">
                  <td>
                    <%= check_box_tag "product_ids[]", product.id, true, 
                        class: 'form-check-input product-checkbox',
                        data: { 
                          bulk_listing_target: "checkbox",
                          action: "change->bulk-listing#toggleSelection"
                        } %>
                  </td>
                  <td>
                    <% if product.images.attached? %>
                      <%= image_tag product.images.first, class: "img-thumbnail", 
                          style: "max-width: 50px; max-height: 50px;" %>
                    <% end %>
                  </td>
                  <td class="product-title"><%= product.title %></td>
                  <td><%= product.sku %></td>
                  <td><%= number_to_currency(product.base_price) %></td>
                  <td><%= product.location %></td>
                  <td>
                    <span class="badge bg-info">
                      <%= product.source_platform&.titleize %>
                    </span>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="text-muted">
            Showing <%= @products.offset_value + 1 %> to <%= @products.offset_value + @products.length %> 
            of <%= @products.total_count %> products
          </div>
          <div>
            <%= paginate @products %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div> 