<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>eBay Listings</h1>
    
    <div class="btn-group">
      <%= button_to "Sync", ebay_import_listings_path, 
          method: :post,
          class: "btn btn-outline-primary",
          data: { turbo: false } %>
      
      <button type="button" 
              class="btn btn-outline-success" 
              id="migrateSelected" 
              disabled>
        Migrate Selected
      </button>
      
      <button type="button" 
              class="btn btn-outline-info" 
              id="migrateAll">
        Migrate All
      </button>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>
                <input type="checkbox" class="form-check-input" id="selectAll">
              </th>
              <th>Title</th>
              <th>Price</th>
              <th>Quantity</th>
              <th>Status</th>
              <th>Last Synced</th>
              <th>Kuralis Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if @listings.any? %>
              <% @listings.each do |listing| %>
                <tr>
                  <td>
                    <input type="checkbox" 
                           class="form-check-input listing-checkbox" 
                           value="<%= listing.id %>"
                           <%= 'disabled' if listing.kuralis_product.present? %>>
                  </td>
                  <td><%= listing.title %></td>
                  <td><%= number_to_currency(listing.sale_price) %></td>
                  <td><%= listing.quantity %></td>
                  <td>
                    <span class="badge <%= listing.active? ? 'bg-success' : 'bg-secondary' %>">
                      <%= listing.ebay_status&.titleize %>
                    </span>
                  </td>
                  <td>
                    <% if listing.last_sync_at %>
                      <%= time_ago_in_words(listing.last_sync_at) %> ago
                    <% else %>
                      Never
                    <% end %>
                  </td>
                  <td>
                    <% if listing.kuralis_product %>
                      <span class="badge bg-success">Migrated</span>
                    <% else %>
                      <span class="badge bg-warning">Not Migrated</span>
                    <% end %>
                  </td>
                  <td>
                    <%= link_to "View on eBay", 
                        "https://www.ebay.com/itm/#{listing.ebay_item_id}", 
                        target: "_blank",
                        class: "btn btn-sm btn-outline-primary" %>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="8" class="text-center">No listings found</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<%= javascript_tag do %>
  document.addEventListener('turbo:load', function() {
    const selectAll = document.getElementById('selectAll');
    const listingCheckboxes = document.querySelectorAll('.listing-checkbox:not([disabled])');
    const migrateSelectedBtn = document.getElementById('migrateSelected');

    // Handle "Select All" checkbox
    selectAll.addEventListener('change', function() {
      listingCheckboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
      updateMigrateSelectedButton();
    });

    // Handle individual checkboxes
    listingCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        updateMigrateSelectedButton();
        
        // Update "Select All" checkbox
        selectAll.checked = Array.from(listingCheckboxes)
          .every(cb => cb.checked);
      });
    });

    // Update "Migrate Selected" button state
    function updateMigrateSelectedButton() {
      const checkedCount = document.querySelectorAll('.listing-checkbox:checked').length;
      migrateSelectedBtn.disabled = checkedCount === 0;
      migrateSelectedBtn.textContent = `Migrate Selected (${checkedCount})`;
    }
  });
<% end %> 